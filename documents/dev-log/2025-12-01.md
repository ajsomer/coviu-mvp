# Development Log - 2025-12-01

## Session Summary

Implemented Phase 1 (Foundation) of the Screenshot Appointment Parsing feature. This phase adds database tables for run sheets and appointments, creates API route stubs, and builds the upload interface with image cropping functionality.

---

## Work Completed

### 1. Database Schema Updates

Added to `src/db/schema.ts`:

**New Enum:**
- `run_sheet_status` - draft/reviewing/confirmed states

**New Tables:**

- **run_sheet_clinicians** - Clinicians extracted from screenshots
  - `id` (uuid, PK)
  - `name` (varchar)
  - `created_at` (timestamp)

- **run_sheets** - Daily run sheets (one per day)
  - `id` (uuid, PK)
  - `date` (date)
  - `status` (run_sheet_status)
  - `created_at` (timestamp)
  - `updated_at` (timestamp)

- **run_sheet_screenshots** - Uploaded/cropped screenshot records
  - `id` (uuid, PK)
  - `run_sheet_id` (uuid, FK)
  - `original_url` (text)
  - `cropped_url` (text)
  - `uploaded_at` (timestamp)
  - `processed_at` (timestamp)
  - `ocr_raw_response` (jsonb)

- **run_sheet_appointments** - Parsed appointments with confidence scores
  - `id` (uuid, PK)
  - `run_sheet_id` (uuid, FK)
  - `screenshot_id` (uuid, FK)
  - `clinician_id` (uuid, FK)
  - `patient_name` (varchar)
  - `patient_phone` (varchar)
  - `appointment_time` (varchar)
  - `appointment_type` (varchar)
  - `confidence` (real)
  - `is_manual_entry` (boolean)
  - `created_at` (timestamp)
  - `updated_at` (timestamp)

**Relations:**
- Added Drizzle relations for all run sheet tables to support `with` queries

### 2. Package Installation

Installed `react-image-crop` for image cropping functionality in the upload UI.

### 3. API Endpoints Created

| Route | Methods | Purpose |
|-------|---------|---------|
| `/api/run-sheet` | GET, DELETE | Get/create or delete today's run sheet |
| `/api/run-sheet/screenshots` | POST | Upload cropped screenshot to Vercel Blob |
| `/api/run-sheet/appointments` | GET, POST | List/create appointments |
| `/api/run-sheet/appointments/[id]` | PATCH, DELETE | Update/delete appointment |
| `/api/run-sheet/confirm` | POST | Confirm run sheet (change status) |
| `/api/run-sheet/clinicians` | GET | Get clinicians for today's run sheet |

### 4. Pages Created

**Run Sheet Pages:**
- `/run-sheet` - Main run sheet page (placeholder for confirmed view)
- `/run-sheet/upload` - Upload page with image cropping UI
- `/run-sheet/review` - Review page placeholder (Phase 4)

### 5. Upload Interface Features

The upload page (`/run-sheet/upload`) includes:
- Drag-and-drop file upload area
- Image cropping with `react-image-crop` library
- Process selected regions one at a time
- Thumbnail gallery of processed regions
- Ability to add multiple regions from same screenshot
- Navigation to review page when done

### 6. Navigation Update

Added "Run Sheet" link to dashboard navigation header.

---

## Files Created

```
src/
├── app/
│   ├── (dashboard)/
│   │   └── run-sheet/
│   │       ├── page.tsx
│   │       ├── upload/page.tsx
│   │       └── review/page.tsx
│   └── api/
│       └── run-sheet/
│           ├── route.ts
│           ├── screenshots/route.ts
│           ├── appointments/route.ts
│           ├── appointments/[id]/route.ts
│           ├── confirm/route.ts
│           └── clinicians/route.ts
```

---

## Files Modified

- `src/db/schema.ts` - Added run sheet tables, enum, relations, and types
- `src/app/(dashboard)/layout.tsx` - Added Run Sheet nav link
- `package.json` - Added react-image-crop dependency

---

## Database Migration

Generated and pushed migration `0001_dazzling_ben_urich.sql`:
```bash
npm run db:generate
npm run db:push
```

---

## Technical Decisions

### Image Cropping Approach

- Client-side cropping using `react-image-crop`
- User selects regions from full screenshot
- Cropped regions uploaded to Vercel Blob
- Multiple regions can be extracted from single screenshot

### Daily Run Sheet Design

- One run sheet per day (date-based)
- GET endpoint auto-creates if not exists
- Status flow: draft → reviewing → confirmed
- DELETE allows re-upload for current day

### OCR Placeholder

- `ocr_raw_response` field added but not populated (Phase 2)
- API returns empty appointments array (will be OCR results in Phase 2)

---

## Testing Notes

To test the upload flow:

1. Navigate to `/run-sheet`
2. Click "Upload Screenshots"
3. Upload a PNG/JPG screenshot
4. Drag to select a region of the image
5. Click "Process This Region"
6. Repeat for additional regions or click "Done"

---

## Phase 2: OCR Pipeline (Implemented)

Implemented the OCR pipeline using Google Cloud Vision API with image preprocessing for optimal text extraction.

### Dependencies Installed

```bash
npm install @google-cloud/vision sharp
npm install --save-dev @types/sharp
```

### Files Created

**`src/lib/ocr/preprocess.ts`** - Image preprocessing for optimal OCR:
- Flattens alpha channel with white background
- Converts to grayscale for better text detection
- Resizes to max width (configurable via `OCR_MAX_WIDTH` env var, default 2000px)
- Sharpens edges for improved edge detection
- Normalizes contrast
- Debug logging when `OCR_DEBUG_LOGGING=true`

**`src/lib/ocr/google-vision.ts`** - Google Cloud Vision client:
- Parses credentials from `GOOGLE_CLOUD_VISION_KEY` environment variable (JSON on single line)
- Uses `documentTextDetection` API (optimized for structured text like tables/forms)
- Traverses response hierarchy: pages → blocks → paragraphs → words
- Returns `OCRResult` with:
  - `fullText` - Complete extracted text
  - `blocks` - Array of `TextBlock` objects with text and bounding box coordinates
  - `rawResponse` - Full API response (when debug enabled)

**`src/lib/ocr/gentu-parser.ts`** - Stub parser for Phase 3:
- Defines `ParsedAppointment` interface
- Returns empty array (parsing logic to be implemented in Phase 3)
- Logs block count and text preview for debugging

### Files Modified

**`src/app/api/run-sheet/screenshots/route.ts`** - Now includes OCR processing:
- Converts uploaded file to Buffer
- Calls `extractTextFromImage()` to run OCR
- Calls `parseGentuScreenshot()` (stub - returns empty array)
- Stores raw OCR response in `ocr_raw_response` column
- Saves parsed appointments to database (when parser is implemented)
- Updates run sheet status to "reviewing"

### Environment Variables Required

```env
# Google Cloud Vision (JSON service account key as single line)
GOOGLE_CLOUD_VISION_KEY={"type":"service_account","project_id":"your-project",...}

# OCR Configuration
OCR_MAX_WIDTH=2000
OCR_DEBUG_LOGGING=true
```

### Technical Details

**Image Preprocessing Pipeline:**
1. `sharp().flatten()` - Remove alpha, add white background
2. `sharp().grayscale()` - Convert to grayscale
3. `sharp().resize()` - Scale to max width (no upscaling)
4. `sharp().sharpen()` - Enhance edges
5. `sharp().normalize()` - Improve contrast
6. `sharp().png()` - Output lossless format

**OCR Response Structure:**
```typescript
interface TextBlock {
  text: string;
  boundingBox: { x: number; y: number; width: number; height: number };
}

interface OCRResult {
  fullText: string;
  blocks: TextBlock[];
  rawResponse?: unknown;
}
```

---

## Phase 3: Parsing Engine (Implemented)

Implemented the Gentu screenshot parsing engine with an interactive column selection workflow. After initial attempts at fully automatic column boundary detection, pivoted to a user-assisted approach where columns are auto-detected but users can adjust boundaries before processing.

### Approach

The Gentu calendar view shows multiple clinician columns side by side. Rather than trying to perfectly auto-detect column boundaries (which had edge cases with overlapping appointments), the system:

1. Auto-detects clinician columns by finding "Dr" headers
2. Displays detected columns as adjustable overlays on the image
3. Lets users drag column edges to fine-tune boundaries
4. Processes each selected column independently as a single-column image

### Files Created

**`src/lib/ocr/column-detector.ts`** - Column detection logic:
- Finds "Dr" headers in top 15% of image
- Calculates column boundaries using midpoints between headers
- Returns percentage-based boundaries for responsive UI
```typescript
export interface DetectedColumn {
  id: string;
  clinicianName: string | null;
  xStart: number;
  xEnd: number;
  xStartPercent: number;
  xEndPercent: number;
}
```

**`src/app/api/run-sheet/detect-columns/route.ts`** - API endpoint:
- Accepts image upload via FormData
- Runs OCR via Google Cloud Vision
- Returns detected columns with clinician names and boundaries
- Detects calendar view vs single-column view

**`src/components/run-sheet/ColumnSelector.tsx`** - Interactive column selection UI:
- Visual overlay of detected columns on screenshot
- Color-coded columns (blue, green, purple, orange, pink)
- Draggable edge handles to adjust boundaries
- Checkbox selection for which columns to process
- Responsive percentage-based positioning

**`src/components/ui/checkbox.tsx`** - Added via shadcn/ui for column selection

### Files Modified

**`src/lib/ocr/gentu-parser.ts`** - Added single-column parsing:

New functions:
- `parseSingleColumnScreenshot()` - Main entry point for cropped columns
- `parseAppointmentClusterSimple()` - Handles null clinician names
- `mergeAdjacentBlocks()` - Merges split phone numbers (e.g., "0400" + "000" + "000")
- `findTimeLabelsInColumn()` - Detects time markers
- `groupBlocksIntoClusters()` - Groups nearby text blocks
- `extractPatientName()` - Extracts patient name from block text
- `extractAppointmentType()` - Detects appointment type phrases
- `normalizeAppointment()` - Cleans and standardizes fields
- `calculateConfidence()` - Scores based on extracted fields

Also changed `DEBUG` constant to `isDebug()` function for runtime evaluation.

**`src/app/(dashboard)/run-sheet/upload/page.tsx`** - New multi-step upload flow:
- Step 1: Upload screenshot
- Step 2: Auto-detect columns (calls `/api/run-sheet/detect-columns`)
- Step 3: Select and adjust columns via ColumnSelector
- Step 4: Process each selected column (crops image, sends to `/api/run-sheet/screenshots`)

Added `cropImageToColumn()` function that uses canvas API to crop image to column boundaries.

**`src/app/api/run-sheet/screenshots/route.ts`** - Updated to use single-column parser:
- Now accepts optional `clinicianName` form field
- Uses `parseSingleColumnScreenshot()` instead of `parseGentuScreenshot()`
- Finds or creates clinician record if name provided

**`src/lib/ocr/google-vision.ts`** - Fixed environment variable timing:
- Changed from module-level client initialization to lazy `getClient()` function
- Prevents "GOOGLE_CLOUD_VISION_KEY not set" errors during build

### Parsing Logic

**Block Merging:**
Phone numbers often appear as split blocks (e.g., "0400", "000", "000"). The parser merges horizontally adjacent blocks that:
- Are within 20px vertically
- Have a horizontal gap < 30px
- Combined text looks like a partial phone number

**Time Detection:**
- Regex patterns for 12hr and 24hr formats
- Maps times to Y positions for appointment association
- Normalizes all times to 24hr format

**Appointment Type Detection:**
Recognizes phrases like:
- "new patient", "review", "follow up", "telehealth"
- "initial", "consult", "standard", "long", "short"
- "results", "procedure", "urgent", "skin check"

**Confidence Scoring:**
- +0.3 for patient name
- +0.3 for phone number
- +0.2 for appointment time
- +0.1 for appointment type
- +0.1 for clinician name

### Technical Decisions

**User-Assisted Column Detection:**
Initial automatic boundary detection had issues with appointments that span column boundaries or unusual spacing. The hybrid approach:
- Still saves user time with auto-detection
- Gives users control to fix edge cases
- More robust across different Gentu configurations

**Percentage-Based Boundaries:**
Column positions stored as percentages (0-100) rather than pixels:
- Works across different display sizes
- Responsive on mobile/desktop
- Consistent cropping regardless of preview scale

**Single-Column Processing:**
Each column is cropped and processed independently:
- Simpler parsing logic (no column boundary tracking)
- Better accuracy (no cross-column contamination)
- Parallel processing possible (though currently sequential)

---

## Next Phases (Not Implemented)

- **Phase 4:** Review UI for editing/confirming appointments
- **Phase 5:** Confirmed run sheet display and telehealth integration

---

*Logged by: Claude Code*
*Date: 2025-12-01*
